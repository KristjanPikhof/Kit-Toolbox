#compdef kit
# Completion script for kit command (auto-generated)
# Provides tab-completion for function names and arguments

local -a commands
local expl

# Get all available functions from function files
_kit_get_commands() {
    local functions_dir="$KIT_EXT_DIR/functions"

    for file in "$functions_dir"/*.sh; do
        if [[ -f "$file" ]]; then
            local functions=$(grep "^# Functions:" "$file" | cut -d: -f2- | xargs | tr ',' ' ')
            for func in $functions; do
                echo "$func"
            done
        fi
    done | sort -u
}

# Get editor shortcuts from editor.conf
_kit_get_editors() {
    local editors_file="$KIT_EXT_DIR/editor.conf"
    [[ -f "$editors_file" ]] || return 0

    while IFS='|' read -r name cmd desc; do
        [[ "$name" =~ ^# ]] && continue
        [[ -z "$name" ]] && continue
        echo "$name"
    done < "$editors_file"
}

# Build command list with descriptions
_kit_build_command_list() {
    local functions_dir="$KIT_EXT_DIR/functions"
    local -a commands_with_desc=()

    for file in "$functions_dir"/*.sh; do
        if [[ -f "$file" ]]; then
            local functions=$(grep "^# Functions:" "$file" | cut -d: -f2- | xargs | tr ',' ' ')
            local category=$(grep "^# Category:" "$file" | cut -d: -f2- | xargs)

            for func in $functions; do
                # Try to get short description from function help
                local desc=$(declare -f "$func" 2>/dev/null | grep -o 'Usage:.*$' | head -1 | sed 's/Usage: kit [^ ]* *//' | sed 's/ *Example.*//' | cut -c1-50)
                if [[ -z "$desc" ]]; then
                    desc="$category"
                fi
                commands_with_desc+=("$func:$desc")
            done
        fi
    done

    # Add editor shortcuts
    local editors_file="$KIT_EXT_DIR/editor.conf"
    if [[ -f "$editors_file" ]]; then
        while IFS='|' read -r name cmd desc; do
            [[ "$name" =~ ^# ]] && continue
            [[ -z "$name" ]] && continue
            commands_with_desc+=("$name:$desc")
        done < "$editors_file"
    fi

    printf '%s\n' "$commands_with_desc[@]"
}

# Main completion logic
case "$CURRENT" in
    2)
        # Complete the command name (first argument after 'kit')
        local -a commands_list=()
        while IFS=: read -r cmd desc; do
            commands_list+=("$cmd:$desc")
        done < <(_kit_build_command_list)

        _describe 'kit commands' commands_list

        # Also add special commands
        local -a special_commands=(
            '-h:Show help'
            '--help:Show help'
            '--search:Search functions by keyword'
            '--list-categories:List all categories'
        )
        _describe 'special commands' special_commands
        ;;
    *)
        # Complete arguments based on the command
        local cmd="${words[2]}"
        # Check if cmd is an editor shortcut
        local is_editor=0
        local editors_file="$KIT_EXT_DIR/editor.conf"
        if [[ -f "$editors_file" ]]; then
            while IFS='|' read -r name editor_cmd desc; do
                [[ "$name" =~ ^# ]] && continue
                [[ -z "$name" ]] && continue
                if [[ "$name" == "$cmd" ]]; then
                    is_editor=1
                    break
                fi
            done < "$editors_file"
        fi

        if [[ $is_editor -eq 1 ]]; then
            _files
        else
            case "$cmd" in
            ccflare-on)
                _files
                ;;
            ccflare-off)
                _files
                ;;
            deps-install)
                _files
                ;;
            deps-check)
                _files
                ;;
            img-resize-width)
                _files
                ;;
            img-resize-percentage)
                _files
                ;;
            img-optimize)
                _files
                ;;
            img-convert)
                _files
                ;;
            img-optimize-to-webp)
                _files
                ;;
            img-resize)
                _files
                ;;
            img-thumbnail)
                _files
                ;;
            img-resize-exact)
                _files
                ;;
            img-resize-fill)
                _files
                ;;
            img-adaptive-resize)
                _files
                ;;
            img-batch-resize)
                _files
                ;;
            img-resize-shrink-only)
                _files
                ;;
            img-resize-colorspace)
                _files
                ;;
            list-files)
                _files
                ;;
            list-all)
                _files
                ;;
            list-reverse)
                _files
                ;;
            list-all-reverse)
                _files
                ;;
            list-tree)
                _files
                ;;
            yt-download)
                if [[ $CURRENT -eq 3 ]]; then
                    _values 'mode' 'mp3' 'mp4'
                elif [[ $CURRENT -eq 4 ]]; then
                    _message 'URL'
                fi
                ;;
            remove-audio)
                _files
                ;;
            convert-to-mp3)
                _files
                ;;
            compress-video)
                _files
                ;;
            mklink)
                _files
                ;;
            killports)
                _files
                ;;
            uninstall)
                if [[ $CURRENT -eq 3 ]]; then
                    _values 'uninstall options' '--purge'
                else
                    _files
                fi
                ;;
            update)
                if [[ $CURRENT -eq 3 ]]; then
                    _values 'update options' '--check-only'
                else
                    _files
                fi
                ;;
            *)
                _files
                ;;
        esac
        fi
        ;;
esac
