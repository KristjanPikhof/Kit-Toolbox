#compdef kit
# Completion script for kit command
# Provides tab-completion for function names and arguments

local -a commands
local expl

# Get all available functions from function files
_kit_get_commands() {
    local functions_dir="$KIT_EXT_DIR/functions"

    for file in "$functions_dir"/*.sh; do
        if [[ -f "$file" ]]; then
            local functions=$(grep "^# Functions:" "$file" | cut -d: -f2- | xargs | tr ',' ' ')
            for func in $functions; do
                echo "$func"
            done
        fi
    done | sort -u
}

# Build command list with descriptions
_kit_build_command_list() {
    local functions_dir="$KIT_EXT_DIR/functions"
    local -a commands_with_desc=()

    for file in "$functions_dir"/*.sh; do
        if [[ -f "$file" ]]; then
            local functions=$(grep "^# Functions:" "$file" | cut -d: -f2- | xargs | tr ',' ' ')
            local category=$(grep "^# Category:" "$file" | cut -d: -f2- | xargs)

            for func in $functions; do
                # Try to get short description from function help
                local desc=$(declare -f "$func" 2>/dev/null | grep -o 'Usage:.*$' | head -1 | sed 's/Usage: kit [^ ]* *//' | sed 's/ *Example.*//' | cut -c1-50)
                if [[ -z "$desc" ]]; then
                    desc="$category"
                fi
                commands_with_desc+=("$func:$desc")
            done
        fi
    done

    printf '%s\n' "$commands_with_desc[@]"
}

# Main completion logic
case "$CURRENT" in
    2)
        # Complete the command name (first argument after 'kit')
        local -a commands_list=()
        while IFS=: read -r cmd desc; do
            commands_list+=("$cmd:$desc")
        done < <(_kit_build_command_list)

        _describe 'kit commands' commands_list

        # Also add special commands
        local -a special_commands=(
            '-h:Show help'
            '--help:Show help'
            '--search:Search functions by keyword'
            '--list-categories:List all categories'
        )
        _describe 'special commands' special_commands
        ;;
    *)
        # Complete arguments based on the command
        local cmd="${words[2]}"
        case "$cmd" in
            # Image processing functions - take file arguments
            img-resize-width|img-resize-percentage|img-optimize|img-resize|img-thumbnail|img-resize-exact|img-resize-fill|img-adaptive-resize|img-resize-shrink-only|img-resize-colorspace|img-batch-resize)
                _files
                ;;
            # Image format conversion - first arg is format, second is format
            img-convert)
                if [[ $CURRENT -eq 3 ]]; then
                    _values 'from format' png jpg jpeg webp heic avif bmp tiff gif pdf
                elif [[ $CURRENT -eq 4 ]]; then
                    _values 'to format' png jpg jpeg webp heic avif bmp tiff gif pdf
                fi
                ;;
            # WebP optimization - no arguments needed
            img-optimize-to-webp)
                _message 'converts all images in current directory'
                ;;
            # YouTube download - mode and URL
            yt-download)
                if [[ $CURRENT -eq 3 ]]; then
                    _values 'mode' mp3 mp4
                elif [[ $CURRENT -eq 4 ]]; then
                    _message 'YouTube URL'
                fi
                ;;
            # Media processing - take file arguments
            remove-audio|convert-to-mp3|compress-video)
                _files
                ;;
            # System utilities
            zed)
                _files
                ;;
            mklink)
                if [[ $CURRENT -eq 3 ]]; then
                    _files
                elif [[ $CURRENT -eq 4 ]]; then
                    _message 'link name'
                fi
                ;;
            # Navigation
            goto)
                _message 'shortcut name'
                ;;
            # File listing functions
            list-files|list-all|list-reverse|list-all-reverse|list-tree|ls|la|lsr|lar|lt)
                _files
                ;;
            # Environment helpers
            ccflare-on|ccflare-off)
                _message 'no arguments needed'
                ;;
            *)
                # Default to file completion for unknown commands
                _files
                ;;
        esac
        ;;
esac
